{% extends "base.html" %}
{% load humanize %}

{% block title %}Daily Financial Summaries{% endblock %}
{% block page_title %}Daily Summaries{% endblock %}

{% block content %}
<div class="p-4 md:p-6">
       <div class="flex flex-col md:flex-row md:items-end flex-wrap gap-2 mb-6">
        <!-- Shared Date Picker -->
        <div>
            <label for="shared-date-filter" class="label-text font-semibold">Select Date</label>
            <input type="date" id="shared-date-filter" class="input input-sm input-bordered w-full max-w-xs" required>
        </div>

        <!-- Filter Form (GET) -->
        <form method="get" action="" class="flex items-end gap-2">
            <input type="hidden" name="date_filter" id="filter-hidden-date">
            <button type="submit" class="btn btn-sm btn-primary">Filter</button>
            <a href="{% url 'accounts:daily_summary_list' %}" class="btn btn-sm btn-ghost">Clear</a>
        </form>

        <!-- Generate Specific Date Summary (POST) -->
        <form method="post" action="{% url 'accounts:generate_specific_date_summary' %}" class="flex items-end gap-2">
            {% csrf_token %}
            <input type="hidden" name="date_filter" id="update-hidden-date">
            <button type="submit" class="btn btn-sm btn-secondary">Update Selected Date</button>
        </form>

        <!-- Generate Today Summary (POST) -->
        <form method="post" action="{% url 'accounts:generate_today_summary' %}" class="flex items-end gap-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-accent btn-sm">Generate/Update Today's Summary</button>
        </form>
    </div>

    <!-- Summary Table -->
    <div class="overflow-x-auto bg-base-100 rounded-box shadow">
        <table class="table table-sm w-full">
            <thead>
                <tr>
                    <th>Date</th>
                    <th class="text-right">Total Revenue</th>
                    <th class="text-right">Expenses</th>
                    <th class="text-right">Debit Today</th>
                    <th class="text-right">Online Sales</th>
                    <th class="text-right">Cash Received</th>
                    <th class="text-right font-bold">Net Settlement</th>
                    <th class="text-right font-bold">Net Physical Cash</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for summary in summaries %}
                <tr class="hover">
                    <td class="font-semibold">{{ summary.summary_date|date:"l, M j" }}</td>
                    <td class="text-right text-info">Rs {{ summary.total_revenue|floatformat:2|intcomma }}</td>
                    <td class="text-right text-warning">- Rs {{ summary.total_expense|floatformat:2|intcomma }}</td>
                    <td class="text-right text-orange-500">- Rs {{ summary.total_debit_today|floatformat:2|intcomma}}</td>
                    <td class="text-right text-purple-500">- Rs {{ summary.online_sales_today|floatformat:2|intcomma }}</td>
                    <td class="text-right text-cyan-500">+ Rs {{ summary.total_cash_received|floatformat:2|intcomma }}</td>
                    
                    <td class="text-right font-bold text-lg {% if summary.net_total_settlement > 0 %}text-success{% else %}text-error{% endif %}">
                        Rs {{ summary.net_total_settlement|floatformat:2|intcomma }}
                    </td>

                    <td class="text-right font-bold text-lg {% if summary.net_physical_cash > 0 %}text-success{% else %}text-error{% endif %}">
                        Rs {{ summary.net_physical_cash|floatformat:2|intcomma }}
                    </td>

                    <td class="text-center">
                        <label for="delete_modal_{{ summary.pk }}" class="btn btn-xs btn-outline btn-error">Delete</label>
                    </td>
                </tr>

                <!-- Delete Confirmation Modal -->
                <input type="checkbox" id="delete_modal_{{ summary.pk }}" class="modal-toggle" />
                <div class="modal" role="dialog">
                    <div class="modal-box">
                        <h3 class="font-bold text-lg text-error">Confirm Deletion</h3>
                        <p class="py-4">Are you sure you want to delete the financial summary for <strong>{{ summary.summary_date|date:"F j, Y" }}</strong>? This action cannot be undone.</p>
                        <div class="modal-action">
                            <label for="delete_modal_{{ summary.pk }}" class="btn btn-ghost">Cancel</label>
                            <form method="post" action="{% url 'accounts:delete_daily_summary' summary_pk=summary.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-error">Yes, Delete</button>
                            </form>
                        </div>
                    </div>
                    <label class="modal-backdrop" for="delete_modal_{{ summary.pk }}">Close</label>
                </div>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-base-content/70 py-8">
                        No financial summaries found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sharedDateInput = document.getElementById('shared-date-filter');
    const filterHiddenInput = document.getElementById('filter-hidden-date');
    const updateHiddenInput = document.getElementById('update-hidden-date');

    function syncDateToHiddenFields() {
        const dateValue = sharedDateInput.value;
        if (filterHiddenInput) filterHiddenInput.value = dateValue;
        if (updateHiddenInput) updateHiddenInput.value = dateValue;
    }

    if (sharedDateInput) {
        sharedDateInput.addEventListener('input', syncDateToHiddenFields);

         // Set default date (today) if empty
        if (!sharedDateInput.value) {
            const urlParams = new URLSearchParams(window.location.search);
            const preservedDate = urlParams.get("date_filter");

            if (preservedDate) {
                sharedDateInput.value = preservedDate;
                syncDateToHiddenFields();
            }
        } 

    }
});
</script>
{% endblock %}
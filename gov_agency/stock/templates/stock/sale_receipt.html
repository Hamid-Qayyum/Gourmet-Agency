<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Receipt #{{ sale.pk }}</title>
    {% load math_filters %}
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fff;
            color: #000;
            font-size: 12pt; /* Standard print size */
        }
        .receipt-container {
            width: 80mm; /* Common thermal printer width, adjust if needed */
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ccc;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        header, footer {
            text-align: center;
            margin-bottom: 15px;
        }
        header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        header p, footer p {
            margin: 2px 0;
            font-size: 0.9em;
        }
        .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .item-table th, .item-table td {
            border-bottom: 1px dashed #ccc;
            padding: 6px 2px;
            text-align: left;
        }
        .item-table th:last-child, .item-table td:last-child {
            text-align: right;
        }
        .item-table .description {
            font-size: 0.9em;
            color: #555;
        }
        .totals-section {
            margin-top: 15px;
            font-size: 1em;
        }
        .totals-section div {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        .totals-section .grand-total {
            font-weight: bold;
            font-size: 1.1em;
            border-top: 1px solid #000;
            margin-top: 5px;
            padding-top: 5px;
        }
        hr.dashed {
            border: none;
            border-top: 1px dashed #555;
            margin: 10px 0;
        }
        .print-button-container {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px; /* Space below button if not printing */
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 10pt; /* Often smaller for actual print */
                background-color: #fff; /* Ensure white background for print */
            }
            .receipt-container {
                width: 100%; /* Use full width of print area */
                margin: 0;
                padding: 5mm;
                border: none;
                box-shadow: none;
            }
            .print-button-container {
                display: none; /* Hide print button when printing */
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <header>
            <h1>{{ company_name|default:"Your Company" }}</h1>
            <p>{{ company_address|default:"123 Store St, City" }}</p>
            <p>Phone: {{ company_phone|default:"(555) 123-4567" }}</p>
            <p>Sale Receipt</p>
        </header>

        <hr class="dashed">

        <div class="info-section" style="font-size: 0.9em; margin-bottom: 10px;">
            <div><strong>Receipt #:</strong> {{ sale.pk }}</div>
            <div><strong>Date:</strong> {{ sale.sale_time|date:"Y-m-d H:i:s" }}</div>
            <div><strong>Cashier:</strong> {{ sale.user.username|default:"N/A" }}</div>
            <div>
                <strong>Customer:</strong> 
                {{ sale.customer_shop.name|default:sale.customer_name_manual|default:"Walk-in Customer" }}
            </div>
            {% if sale.customer_shop.contact_phone %}
                <div><strong>Shop Phone:</strong> {{ sale.customer_shop.contact_phone }}</div>
            {% endif %}
             {% if sale.needs_vehicle and sale.assigned_vehicle %}
                <div><strong>Delivery Vehicle:</strong> {{ sale.assigned_vehicle.vehicle_number }}</div>
            {% endif %}
        </div>

        <hr class="dashed">

        <table class="item-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th style="text-align:center;">Qty</th>
                    <th style="text-align:right;">Price</th>
                    <th style.="text-align:right;">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {{ sale.product_detail_snapshot.product_base.name }}
                        <div class="description">
                            {{ sale.product_detail_snapshot.packing_type }} 
                            ({{ sale.product_detail_snapshot.quantity_in_packing|floatformat:"-2g" }} {{ sale.product_detail_snapshot.unit_of_measure }})
                            <br>Exp: {{ sale.expiry_date_at_sale|date:"d M Y" }}
                        </div>
                    </td>
                    <td style="text-align:center;">{{ actual_sold_items_count }}</td>
                    <td style="text-align:right;">Rs {{ sale.selling_price_per_item|floatformat:2 }}</td>
                    <td style="text-align:right;">Rs {{ sale.final_total_revenue|floatformat:2 }}</td>
                </tr>
                {# If a sale could have multiple items, you would loop through sale.items.all here #}
                {# Since your Sale model is for one product_detail batch, we show it directly #}
            </tbody>
        </table>
        
        <div class="totals-section">
            <div>
                <span>Subtotal (Dispatched):</span>
                <span>Rs {{ sale.total_revenue_dispatch|floatformat:2 }}</span>
            </div>
            {% if sale.returned_individual_items_count > 0 %}
            <div>
                <span>Items Returned:</span>
                <span>{{ sale.returned_individual_items_count }} item(s)</span>
            </div>
            <div>
                <span>Return Value:</span>
                <span>- Rs {{ sale.returned_individual_items_count|multiply:sale.selling_price_per_item|floatformat:2 }}</span>
            </div>
            {% endif %}
            <hr class="dashed" style="margin: 5px 0;">
            <div class="grand-total">
                <span>TOTAL DUE:</span>
                <span>Rs {{ sale.final_total_revenue|floatformat:2 }}</span>
            </div>
             <div>
                <span>Payment Type:</span>
                <span>{{ sale.get_payment_type_display }}</span>
            </div>
        </div>

        <hr class="dashed">
        <footer>
            <p>Thank you for your business!</p>
            {% if sale.status != 'COMPLETED' %}
            <p style="font-weight:bold; margin-top:5px;">Status: {{ sale.get_status_display }}</p>
            {% endif %}
        </footer>
    </div>

    <div class="print-button-container">
        <button onclick="window.print();" class="btn btn-lg btn-success">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
            Print Receipt
        </button>
         <a href="{% url 'stock:sales' %}" class="btn btn-lg btn-outline">Back to Sales</a>
    </div>
</body>
</html>